# ---------- Builder stage: build wheels ----------
FROM python:3.12-slim-bullseye AS builder

ENV PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    POETRY_VIRTUALENVS_CREATE=false

WORKDIR /build

# Install build dependencies (only in builder)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    gcc \
    libpq-dev \
    python3-dev \
    libffi-dev \
    ca-certificates \
    curl \
 && rm -rf /var/lib/apt/lists/*

# Copy requirements and create wheels (faster final installs, avoids compilation in runtime)
COPY requirements.txt .
RUN python -m pip install --upgrade pip setuptools wheel \
 && pip wheel --no-deps --wheel-dir /wheels -r requirements.txt

# Copy application source (for packaging and context)
COPY . /build/app

# ---------- Runtime stage: minimal runtime ----------
FROM python:3.12-slim-bullseye AS runtime

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    PATH="/opt/venv/bin:$PATH" \
    DJANGO_SETTINGS_MODULE=conf.settings

WORKDIR /app

# Install minimal runtime OS deps (no build tools)
RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq5 \
    tini \
    ca-certificates \
    curl \
 && rm -rf /var/lib/apt/lists/*

# create an unprivileged user (useful for dropping privileges)
ARG APP_USER=appuser
ARG APP_UID=1000
RUN groupadd -g ${APP_UID} ${APP_USER} \
 && useradd -m -u ${APP_UID} -g ${APP_UID} ${APP_USER}

# Copy wheels and app from builder into /app and set ownership in one step
COPY --from=builder /wheels /wheels
COPY --from=builder --chown=${APP_USER}:${APP_USER} /build/app /app

# Create a small venv and install from the pre-built wheels (or fallback to PyPI)
RUN python -m venv /opt/venv \
 && /opt/venv/bin/pip install --upgrade pip \
 && /opt/venv/bin/pip install --no-index --find-links /wheels -r requirements.txt \
    || /opt/venv/bin/pip install --no-cache-dir -r requirements.txt \
 && rm -rf /wheels /root/.cache/pip

# Copy entrypoint (make sure your entrypoint drops privileges and does not embed secrets)
COPY docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
RUN chmod +x /usr/local/bin/docker-entrypoint.sh

# Ensure app directory owned by unprivileged user
RUN chown -R ${APP_USER}:${APP_USER} /app

# NOTE: keep ENTRYPOINT run as root so it can read mounted .env regardless of host UID, then drop privileges inside entrypoint
USER root

EXPOSE 8000
STOPSIGNAL SIGTERM

# Use tini as pid 1 to handle signals properly
ENTRYPOINT ["/usr/bin/tini", "--", "/usr/local/bin/docker-entrypoint.sh"]

# Default CMD (overrideable)
CMD ["gunicorn", "conf.asgi:application", "-w", "3", "-k", "uvicorn.workers.UvicornWorker", "-b", "0.0.0.0:8000", "--log-level", "info"]
